<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad & Media Viewer (file.io)</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #drop-zone {
      border: 2px dashed #007bff;
      padding: 20px;
      margin-bottom: 10px;
      cursor: pointer;
      color: #555;
      text-align: center;
    }
    #ads-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      margin-top: 20px;
    }
    iframe, img, video {
      display: block;
      border: none;
      max-width: none;
      height: auto;
    }
    #file-input {
      display: none;
    }
    .btn {
      display: inline-block;
      padding: 8px 16px;
      margin: 10px 5px 0 5px;
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 4px;
    }
    .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #share-link {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-size: 0.9rem;
      height: 60px;
      resize: none;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Ad & Media Viewer (file.io)</h1>
  <div id="drop-zone">Drop your files here (ZIP, images, videos) or click to browse</div>
  <div style="text-align:center;">
    <button id="upload-btn" class="btn">Upload to file.io</button>
    <button id="share-btn" class="btn" disabled>Generate Share Link</button>
    <br/>
    <textarea id="share-link" readonly placeholder="Your shareable link will appear here..."></textarea>
  </div>
  <div id="ads-container"></div>

  <!-- Hidden file input -->
  <input
    id="file-input"
    type="file"
    accept=".zip, .gif, .jpg, .jpeg, .png, .webp, .svg, .mp4, .webm"
    multiple
  />

  <!-- (Optional) JSZip if you want to parse ZIP banners -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    /********************************************
     * 1) Basic Variables & Setup
     ********************************************/
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const shareBtn = document.getElementById('share-btn');
    const shareLinkField = document.getElementById('share-link');
    const adsContainer = document.getElementById('ads-container');

    let selectedFiles = [];   // local File objects
    let uploadedFiles = [];   // { name, url } after file.io

    /********************************************
     * 2) Drag & Drop / File Selection
     ********************************************/
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#28a745';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#007bff';
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#007bff';
      const files = Array.from(e.dataTransfer.files);
      handleNewFiles(files);
    });
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleNewFiles(files);
      fileInput.value = "";
    });

    function handleNewFiles(files) {
      selectedFiles.push(...files);
      displayLocalFiles(files);
    }

    /********************************************
     * 3) Display Files (Local Preview)
     ********************************************/
    function displayLocalFiles(files) {
      for (const file of files) {
        if (file.name.toLowerCase().endsWith('.zip')) {
          // If you want to parse ZIP with JSZip, do that here or after upload.
          const div = document.createElement('div');
          div.textContent = `ZIP file: ${file.name}`;
          adsContainer.appendChild(div);
        }
        else if (/\.(gif|jpg|jpeg|png|webp|svg)$/i.test(file.name)) {
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          adsContainer.appendChild(img);
        }
        else if (/\.(mp4|webm)$/i.test(file.name)) {
          const vid = document.createElement('video');
          vid.src = URL.createObjectURL(file);
          vid.controls = true;
          adsContainer.appendChild(vid);
        }
        else {
          const div = document.createElement('div');
          div.textContent = `Unsupported local preview: ${file.name}`;
          adsContainer.appendChild(div);
        }
      }
    }

    /********************************************
     * 4) Upload to file.io
     ********************************************/
    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) {
        alert("No files selected.");
        return;
      }
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";

      for (const file of selectedFiles) {
        try {
          const link = await uploadFileToFileIo(file);
          uploadedFiles.push({ name: file.name, url: link });
        } catch (err) {
          console.error("Upload error:", err);
          alert(`Failed to upload ${file.name}: ${err.message}`);
        }
      }

      uploadBtn.textContent = "Upload to file.io";
      uploadBtn.disabled = false;
      // Enable share link if we have at least one success
      if (uploadedFiles.length > 0) {
        shareBtn.disabled = false;
      }
    });

    // Actually POST to file.io
    async function uploadFileToFileIo(file) {
      // We'll set 14 days expiry and allow up to 10 downloads
      const url = 'https://file.io?expires=14d&maxDownloads=10';
      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch(url, {
        method: 'POST',
        body: formData
      });
      if (!response.ok) {
        throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
      }
      const json = await response.json();
      if (!json.success) {
        throw new Error(`Upload error: ${JSON.stringify(json)}`);
      }
      // "json.link" is the file's download URL
      return json.link;
    }

    /********************************************
     * 5) Generate a Share Link (hash-based)
     ********************************************/
    shareBtn.addEventListener('click', () => {
      if (uploadedFiles.length === 0) {
        alert("No uploaded files to share.");
        return;
      }
      const encoded = btoa(JSON.stringify(uploadedFiles));
      const shareURL = `${location.origin}${location.pathname}#${encoded}`;
      shareLinkField.value = shareURL;
      shareLinkField.select();
      document.execCommand('copy'); // older browsers
      alert("Share link copied to clipboard!");
    });

    /********************************************
     * 6) On Page Load, Check Hash -> Re-fetch
     ********************************************/
    window.addEventListener('load', async () => {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return;
      try {
        const arr = JSON.parse(atob(hash)); // array of { name, url }
        if (!Array.isArray(arr)) return;

        uploadedFiles = arr;
        shareBtn.disabled = false; // we have something to share

        // Re-fetch each file from file.io and display
        for (const item of arr) {
          try {
            await fetchAndDisplay(item.url, item.name);
          } catch (err) {
            console.error("Failed to fetch file:", err);
          }
        }
      } catch (err) {
        console.error("Invalid hash data:", err);
      }
    });

    // Download from file.io, convert to Blob/File, display in adsContainer
    async function fetchAndDisplay(url, name) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status} - ${resp.statusText}`);
      const blob = await resp.blob();

      if (name.toLowerCase().endsWith('.zip')) {
        const div = document.createElement('div');
        div.textContent = `ZIP file from link: ${name}`;
        adsContainer.appendChild(div);
        // If you want to parse with JSZip:
        // const zipFile = new File([blob], name);
        // processZipFiles([zipFile]);
      }
      else if (/\.(gif|jpg|jpeg|png|webp|svg)$/i.test(name)) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.alt = name;
        adsContainer.appendChild(img);
      }
      else if (/\.(mp4|webm)$/i.test(name)) {
        const vid = document.createElement('video');
        vid.src = URL.createObjectURL(blob);
        vid.controls = true;
        adsContainer.appendChild(vid);
      }
      else {
        const div = document.createElement('div');
        div.textContent = `File from link: ${name} (unsupported preview)`;
        adsContainer.appendChild(div);
      }
    }
  </script>
</body>
</html>
