<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ad & Media Viewer with Transfer.sh</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #drop-zone {
      border: 2px dashed #007bff;
      padding: 20px;
      margin-bottom: 10px;
      cursor: pointer;
      color: #555;
      text-align: center;
    }
    #ads-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
      margin-top: 20px;
    }
    iframe, img, video {
      display: block;
      border: none;
      max-width: none;
      height: auto;
    }
    #file-input {
      display: none;
    }
    .btn {
      display: inline-block;
      padding: 8px 16px;
      margin: 10px 5px 0 5px;
      background: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      border-radius: 4px;
    }
    .btn:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    #share-link {
      width: 100%;
      margin-top: 10px;
      padding: 8px;
      font-size: 0.9rem;
      height: 60px;
      resize: none;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Ad & Media Viewer (Transfer.sh)</h1>
  <div id="drop-zone">Drop your files here (ZIP, images, videos) or click to browse</div>
  <div style="text-align:center;">
    <button id="upload-btn" class="btn">Upload to transfer.sh</button>
    <button id="share-btn" class="btn" disabled>Generate Share Link</button>
    <br/>
    <textarea id="share-link" readonly placeholder="Your shareable link will appear here..."></textarea>
  </div>
  <div id="ads-container"></div>

  <!-- Hidden file input -->
  <input
    id="file-input"
    type="file"
    accept=".zip, .gif, .jpg, .jpeg, .png, .webp, .svg, .mp4, .webm"
    multiple
  />

  <!-- JSZip if you want to process ZIPs for HTML5 ads -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    /********************************************
     * 1) Basic Variables & Setup
     ********************************************/
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadBtn = document.getElementById('upload-btn');
    const shareBtn = document.getElementById('share-btn');
    const shareLinkField = document.getElementById('share-link');
    const adsContainer = document.getElementById('ads-container');

    // We'll store "local" files (before upload) and "uploaded" info
    let selectedFiles = [];     // File objects from user
    let uploadedFiles = [];     // { name, url } after transfer.sh

    /********************************************
     * 2) Drag & Drop / File Selection
     ********************************************/
    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#28a745';
    });
    dropZone.addEventListener('dragleave', () => {
      dropZone.style.borderColor = '#007bff';
    });
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.style.borderColor = '#007bff';
      const files = Array.from(e.dataTransfer.files);
      handleNewFiles(files);
    });
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      handleNewFiles(files);
      fileInput.value = "";
    });

    function handleNewFiles(files) {
      // Just store them in selectedFiles for now
      selectedFiles.push(...files);
      // Display them locally (no transfer.sh URL yet)
      displayLocalFiles(files);
    }

    /********************************************
     * 3) Display Files (Local Preview)
     ********************************************/
    function displayLocalFiles(files) {
      for (const file of files) {
        // If it's a ZIP, we won't display a direct preview,
        // but we can eventually process it with JSZip if desired.
        if (file.name.toLowerCase().endsWith('.zip')) {
          const div = document.createElement('div');
          div.textContent = `ZIP file (will need JSZip processing): ${file.name}`;
          adsContainer.appendChild(div);
        } 
        else if (/\.(gif|jpg|jpeg|png|webp|svg)$/i.test(file.name)) {
          // Display as an <img>
          const img = document.createElement('img');
          img.src = URL.createObjectURL(file);
          img.alt = file.name;
          adsContainer.appendChild(img);
        }
        else if (/\.(mp4|webm)$/i.test(file.name)) {
          // Display as a <video>
          const vid = document.createElement('video');
          vid.src = URL.createObjectURL(file);
          vid.controls = true;
          adsContainer.appendChild(vid);
        }
        else {
          const div = document.createElement('div');
          div.textContent = `Unsupported local preview: ${file.name}`;
          adsContainer.appendChild(div);
        }
      }
    }

    /********************************************
     * 4) Upload to Transfer.sh
     ********************************************/
    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) {
        alert("No files selected.");
        return;
      }
      // Disable upload button while uploading
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Uploading...";

      // Upload each file, get back a link
      for (const file of selectedFiles) {
        try {
          const link = await uploadFileToTransferSh(file);
          uploadedFiles.push({ name: file.name, url: link });
        } catch (err) {
          console.error("Upload error:", err);
          alert(`Failed to upload ${file.name}: ${err.message}`);
        }
      }
      // Re-enable
      uploadBtn.textContent = "Upload to transfer.sh";
      uploadBtn.disabled = false;

      // Now that we have uploaded, we can enable "Generate Share Link"
      if (uploadedFiles.length > 0) {
        shareBtn.disabled = false;
      }
    });

    // Actual upload function for transfer.sh
    async function uploadFileToTransferSh(file) {
      // transfer.sh can handle a PUT to https://transfer.sh/filename
      const filename = encodeURIComponent(file.name);
      const url = `https://transfer.sh/${filename}`;
      const response = await fetch(url, {
        method: 'PUT',
        headers: {
          'Content-Type': file.type || 'application/octet-stream'
        },
        body: file
      });
      if (!response.ok) {
        throw new Error(`Upload failed: ${response.status} ${response.statusText}`);
      }
      // transfer.sh returns the download URL in plain text
      const downloadUrl = (await response.text()).trim();
      return downloadUrl;
    }

    /********************************************
     * 5) Generate a Share Link (store URLs in hash)
     ********************************************/
    shareBtn.addEventListener('click', () => {
      if (uploadedFiles.length === 0) {
        alert("No uploaded files to share.");
        return;
      }
      // We'll store an array of { name, url } in the hash
      const encoded = btoa(JSON.stringify(uploadedFiles));
      const shareURL = `${location.origin}${location.pathname}#${encoded}`;
      shareLinkField.value = shareURL;
      shareLinkField.select();
      document.execCommand('copy'); // copies to clipboard in many browsers
      alert("Share link copied to clipboard!");
    });

    /********************************************
     * 6) On Page Load, Check if There's a Hash
     *    -> Re-fetch files from transfer.sh
     ********************************************/
    window.addEventListener('load', async () => {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return; // no preloaded data
      try {
        const jsonStr = atob(hash);
        const arr = JSON.parse(jsonStr); // array of { name, url }
        if (!Array.isArray(arr)) return;

        // We'll store them in uploadedFiles so we don't re-upload
        uploadedFiles = arr;
        shareBtn.disabled = false; // We already have something to share

        // Now we "display" them by fetching each URL as a Blob
        // so we can show them in the container
        for (const item of arr) {
          try {
            await fetchAndDisplay(item.url, item.name);
          } catch (err) {
            console.error("Failed to fetch file from transfer.sh:", err);
          }
        }
      } catch (err) {
        console.error("Invalid hash data:", err);
      }
    });

    async function fetchAndDisplay(url, name) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`HTTP ${resp.status} - ${resp.statusText}`);
      const blob = await resp.blob();

      // If it's a ZIP, you might do JSZip processing, etc.
      // For images:
      if (/\.(gif|jpg|jpeg|png|webp|svg)$/i.test(name)) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(blob);
        img.alt = name;
        adsContainer.appendChild(img);
      }
      // For videos
      else if (/\.(mp4|webm)$/i.test(name)) {
        const vid = document.createElement('video');
        vid.src = URL.createObjectURL(blob);
        vid.controls = true;
        adsContainer.appendChild(vid);
      }
      // For .zip, you could do a more advanced approach with JSZip
      else if (name.toLowerCase().endsWith('.zip')) {
        const div = document.createElement('div');
        div.textContent = `ZIP file from link: ${name}`;
        adsContainer.appendChild(div);
        // (Optional) parse with JSZip to display an HTML5 banner
      }
      else {
        const div = document.createElement('div');
        div.textContent = `File from link: ${name} (unsupported preview)`;
        adsContainer.appendChild(div);
      }
    }
  </script>
</body>
</html>
